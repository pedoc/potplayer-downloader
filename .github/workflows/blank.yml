name: Daily Download & Upload PotPlayer to Release

on:
  schedule:
    # 每天 UTC 00:00 执行
    - cron: '0 0 * * *'
  
  # 允许手动触发测试
  workflow_dispatch:

jobs:
  download-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # 必须要有创建 release 和上传 asset 的权限

    steps:
      # 1. 检出仓库（通常用于后续操作）
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. 获取当前日期（用于文件名和 tag）
      - name: Get current date
        id: date
        run: echo "date=$(date +%Y%m%d)" >> $GITHUB_OUTPUT

      # 3. 下载最新 PotPlayer 安装包
      - name: Download PotPlayerSetup64
        run: |
          FILENAME="PotPlayerSetup64-${{ steps.date.outputs.date }}.exe"
          wget -O "$FILENAME" \
            https://t1.daumcdn.net/potplayer/PotPlayer/Version/Latest/PotPlayerSetup64.exe
          echo "Downloaded file: $FILENAME"
          ls -lh "$FILENAME"

      # 4. 检查文件是否真的下载成功（大小 > 30MB 才算合理）
      - name: Verify downloaded file
        run: |
          FILENAME="PotPlayerSetup64-${{ steps.date.outputs.date }}.exe"
          FILE_SIZE=$(stat -c%s "$FILENAME")
          if [ "$FILE_SIZE" -lt 30000000 ]; then
            echo "Error: Downloaded file too small ($FILE_SIZE bytes)"
            exit 1
          fi

      # 5. 创建或更新 Release 并上传文件
      - name: Create/Update Release and Upload Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: daily-${{ steps.date.outputs.date }}
          name: PotPlayer Latest - ${{ steps.date.outputs.date }}
          body: |
            Auto-updated PotPlayer 64-bit installer
            Date: ${{ steps.date.outputs.date }}
            Source: https://potplayer.daum.net/
          prerelease: true
          # 如果同一天 tag 已存在，就更新它（不会重复创建）
          generate_release_notes: false
          files: |
            PotPlayerSetup64-${{ steps.date.outputs.date }}.exe
